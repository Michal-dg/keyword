<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword: Ucz się angielskiego</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/icons/icon-192x192.png" type="image/png">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-md mx-auto p-4 sm:p-6">
        <header class="text-center mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-600">Keyword</h1>
            <p class="text-slate-500 mt-1">Opanuj angielski, słówko po słówku!</p>
        </header>

        <nav class="flex justify-center items-center space-x-4 mb-6 border-b pb-4">
            <button id="show-auth-btn" title="Konto Użytkownika" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600">
                <svg id="auth-icon-user" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <svg id="auth-icon-logout" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </button>
            <button id="show-decks-btn" title="Talie" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 16V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"></path><path d="M20 12v4H4v-4"></path><path d="M4 8h16"></path></svg>
            </button>
        </nav>

        <main id="main-content">
            <div id="loading-state" class="text-center p-8"><p class="text-slate-500">Ładowanie aplikacji...</p></div>
            <div id="welcome-state" class="hidden text-center p-8"><p class="text-slate-600">Zaloguj się, aby zobaczyć swoje talie i rozpocząć naukę.</p></div>
            <div id="learning-state" class="hidden">
                 <div class="text-center mb-4"><p class="text-sm text-slate-500">Aktywna talia: <strong id="active-deck-name" class="text-sky-600">Brak</strong></p></div>
                 <div id="words-view" class="bg-white p-4 rounded-lg shadow">
                     <div id="words-list">Wybierz talię, aby zobaczyć słówka.</div>
                     <button id="show-add-word-modal-btn" class="mt-4 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Dodaj nowe słówka</button>
                 </div>
            </div>
        </main>
    </div>

    <div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-sm">
            <header class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Logowanie / Rejestracja</h2><button class="close-modal-btn p-2 text-2xl">&times;</button></header>
            <div class="p-6">
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Email" required autocomplete="email" class="w-full px-3 py-2 border rounded-md">
                    <input type="password" id="auth-password" placeholder="Hasło" required autocomplete="current-password" class="w-full px-3 py-2 border rounded-md">
                    <div id="auth-error-message" class="text-red-500 text-sm hidden"></div>
                    <div class="flex gap-4">
                        <button id="login-btn" type="submit" class="flex-1 bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600">Zaloguj</button>
                        <button id="register-btn" type="submit" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg">Zarejestruj</button>
                    </div>
                </form>
                <div id="user-info" class="hidden mt-4 text-center">
                    <p>Zalogowano jako: <strong id="user-email-display"></strong></p>
                    <button id="logout-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">Wyloguj</button>
                </div>
            </div>
        </div>
    </div>
    <div id="decks-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg">
            <header class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Twoje talie</h2><button class="close-modal-btn p-2 text-2xl">&times;</button></header>
            <div id="decks-list" class="p-4 overflow-y-auto max-h-[60vh]"></div>
            <div class="p-4 border-t">
                <form id="add-deck-form" class="flex gap-2">
                    <input type="text" id="new-deck-name" placeholder="Nazwa nowej talii..." class="flex-grow w-full px-3 py-2 border rounded-md" required>
                    <button type="submit" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600">Stwórz</button>
                </form>
            </div>
        </div>
    </div>
    <div id="add-word-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg">
            <header class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Dodaj słówka</h2><button class="close-modal-btn p-2 text-2xl">&times;</button></header>
            <form id="add-word-form" class="p-6">
                <textarea id="bulk-words-input" required class="w-full px-3 py-2 border rounded-md h-48" placeholder="english;polish&#10;car;samochód"></textarea>
                <button type="submit" class="mt-4 w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600">Zapisz słówka</button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // === 1. KONFIGURACJA I ZMIENNE ===
    const SUPABASE_URL = 'https://elneujplpdoruvrvzvzd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsbmV1anBscGRvcnV2cnZ6dnpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDQ3NjYsImV4cCI6MjA3MjM4MDc2Nn0.YIJYmt8KeiXH0iFS_Pk6ErIkyKZpPDsi29G83VItjCc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let db;
    let activeDeckId = null;

    // === 2. ELEMENTY DOM ===
    const loadingState = document.getElementById('loading-state');
    const welcomeState = document.getElementById('welcome-state');
    const learningState = document.getElementById('learning-state');
    const activeDeckNameEl = document.getElementById('active-deck-name');
    const decksListEl = document.getElementById('decks-list');
    const wordsListEl = document.getElementById('words-list');
    const authModal = document.getElementById('auth-modal');
    const decksModal = document.getElementById('decks-modal');
    const addWordModal = document.getElementById('add-word-modal');
    const showAuthBtn = document.getElementById('show-auth-btn');
    const showDecksBtn = document.getElementById('show-decks-btn');
    const showAddWordModalBtn = document.getElementById('show-add-word-modal-btn');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const addDeckForm = document.getElementById('add-deck-form');
    const addWordForm = document.getElementById('add-word-form');
    const authIconUser = document.getElementById('auth-icon-user');
    const authIconLogout = document.getElementById('auth-icon-logout');
    const userInfo = document.getElementById('user-info');
    const authForm = document.getElementById('auth-form');
    const authErrorMessage = document.getElementById('auth-error-message');
    const userEmailDisplay = document.getElementById('user-email-display');

    // === 3. FUNKCJE POMOCNICZE ===
    const openModal = (modal) => modal.classList.remove('pointer-events-none', 'opacity-0');
    const closeModal = (modal) => modal.classList.add('pointer-events-none', 'opacity-0');
    const idbRequest = (request) => new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(e.target.error);
    });
    const getTransaction = (storeName, mode) => db.transaction(storeName, mode).objectStore(storeName);

    // === 4. BAZA DANYCH INDEXEDDB ===
    async function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('KeywordDB_v2', 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('decks')) db.createObjectStore('decks', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('words')) {
                    const store = db.createObjectStore('words', { keyPath: 'id' });
                    store.createIndex('deckId', 'deck_id', { unique: false });
                }
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    // === 5. GŁÓWNA LOGIKA DANYCH ===
    async function syncAndRenderDecks() {
        decksListEl.innerHTML = '<p>Ładowanie talii...</p>';
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            decksListEl.innerHTML = '<p>Zaloguj się, aby zobaczyć swoje talie.</p>';
            return;
        }
        
        const { data: cloudDecks, error } = await supabaseClient.from('decks').select('id, name').eq('user_id', user.id).order('name');
        if (error) {
            console.error("Błąd pobierania talii:", error);
            decksListEl.innerHTML = '<p class="text-red-500">Nie udało się załadować talii.</p>';
            return;
        }

        if (cloudDecks.length === 0) {
            decksListEl.innerHTML = '<p>Nie masz jeszcze żadnych talii.</p>';
        } else {
            decksListEl.innerHTML = cloudDecks.map(deck => `
                <div class="deck-item flex justify-between items-center p-2 hover:bg-slate-100 rounded-md cursor-pointer" data-deck-id="${deck.id}" data-deck-name="${deck.name}">
                    <span>${deck.name}</span>
                    <button data-delete-id="${deck.id}" class="delete-deck-btn text-red-400 hover:text-red-600 font-bold text-xl">&times;</button>
                </div>
            `).join('');
        }
    }

    async function syncAndRenderWords(deckId) {
        activeDeckId = deckId;
        const deckName = decksListEl.querySelector(`[data-deck-id="${deckId}"]`)?.dataset.deckName || 'Talia';
        activeDeckNameEl.textContent = deckName;
        
        wordsListEl.innerHTML = '<p>Ładowanie słówek...</p>';

        const { data: cloudWords, error } = await supabaseClient.from('words').select('*').eq('deck_id', deckId);
        if (error) {
            console.error("Błąd pobierania słówek:", error);
            wordsListEl.innerHTML = '<p class="text-red-500">Błąd ładowania słówek.</p>';
            return;
        }

        const wordsHtml = cloudWords.length === 0 
            ? '<p>Brak słówek w tej talii. Dodaj pierwsze!</p>'
            : cloudWords.map(word => `<div class="p-2 border rounded-md flex justify-between items-center"><span><strong>${word.english}</strong> - ${word.polish}</span><button data-delete-id="${word.id}" class="delete-word-btn text-red-400 hover:text-red-600">&times;</button></div>`).join('');
        
        wordsListEl.innerHTML = wordsHtml;
    }

    // === 6. OBSŁUGA ZDARZEŃ ===
    addDeckForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const deckNameInput = document.getElementById('new-deck-name');
        const deckName = deckNameInput.value.trim();
        if (!deckName) return;
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return alert('Musisz być zalogowany.');
        const { error } = await supabaseClient.from('decks').insert({ name: deckName, user_id: user.id });
        if (error) {
            console.error('Nie udało się dodać talii:', error);
            alert('Błąd podczas tworzenia talii.');
        } else {
            deckNameInput.value = '';
            await syncAndRenderDecks();
        }
    });
    
    addWordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const bulkInput = document.getElementById('bulk-words-input');
        const text = bulkInput.value.trim();
        if (!text || !activeDeckId) return alert("Najpierw wybierz talię.");
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return alert('Musisz być zalogowany.');
        const wordsToInsert = text.split('\n').map(line => {
            const [english, polish] = line.split(';').map(s => s.trim());
            return { english, polish, deck_id: activeDeckId, user_id: user.id };
        }).filter(w => w.english && w.polish);
        if (wordsToInsert.length === 0) return;
        const { error } = await supabaseClient.from('words').insert(wordsToInsert);
        if (error) {
            console.error("Błąd zapisu słówek:", error);
            alert("Nie udało się zapisać słówek.");
        } else {
            bulkInput.value = '';
            closeModal(addWordModal);
            await syncAndRenderWords(activeDeckId);
        }
    });

    decksListEl.addEventListener('click', async (e) => {
        const deckItem = e.target.closest('.deck-item');
        const deleteBtn = e.target.closest('.delete-deck-btn');
        if (deleteBtn) {
            e.stopPropagation();
            if (confirm('Czy na pewno chcesz usunąć tę talię? Usunie to również wszystkie jej słówka.')) {
                await supabaseClient.from('decks').delete().eq('id', deleteBtn.dataset.deleteId);
                await syncAndRenderDecks();
                if (activeDeckId === deleteBtn.dataset.deleteId) {
                    activeDeckId = null;
                    activeDeckNameEl.textContent = 'Brak';
                    wordsListEl.innerHTML = 'Wybierz talię, aby zobaczyć słówka.';
                }
            }
        } else if (deckItem) {
            closeModal(decksModal);
            await syncAndRenderWords(deckItem.dataset.deckId);
        }
    });
    
    learningState.addEventListener('click', async (e) => {
        if (e.target.id === 'show-add-word-modal-btn') {
            if (!activeDeckId) return alert("Najpierw wybierz aktywną talię z listy.");
            openModal(addWordModal);
        }
        const deleteBtn = e.target.closest('.delete-word-btn');
        if (deleteBtn) {
            if (confirm('Czy na pewno chcesz usunąć to słówko?')) {
                await supabaseClient.from('words').delete().eq('id', deleteBtn.dataset.deleteId);
                await syncAndRenderWords(activeDeckId);
            }
        }
    });
    
    // --- 7. LOGIKA AUTENTYKACJI ---
    function updateAuthUI(user) {
        authIconUser.classList.toggle('hidden', !!user);
        authIconLogout.classList.toggle('hidden', !user);
        userInfo.classList.toggle('hidden', !user);
        authForm.classList.toggle('hidden', !!user);
        if (user) userEmailDisplay.textContent = user.email;
    }

    supabaseClient.auth.onAuthStateChange(async (_event, session) => {
        const user = session?.user;
        updateAuthUI(user);
        loadingState.classList.add('hidden');
        if (user) {
            welcomeState.classList.add('hidden');
            learningState.classList.remove('hidden');
            await syncAndRenderDecks();
        } else {
            activeDeckId = null;
            decksListEl.innerHTML = '';
            learningState.classList.add('hidden');
            welcomeState.classList.remove('hidden');
        }
    });

    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const { error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('auth-email').value, password: document.getElementById('auth-password').value });
        authErrorMessage.classList.toggle('hidden', !error);
        if (error) authErrorMessage.textContent = error.message;
        else closeModal(authModal);
    });

    registerBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const { error } = await supabaseClient.auth.signUp({ email: document.getElementById('auth-email').value, password: document.getElementById('auth-password').value });
        if (error) {
            authErrorMessage.textContent = error.message;
            authErrorMessage.classList.remove('hidden');
        } else {
            alert('Rejestracja pomyślna! Sprawdź email, aby potwierdzić konto.');
            closeModal(authModal);
        }
    });

    logoutBtn.addEventListener('click', () => supabaseClient.auth.signOut());
    showAuthBtn.addEventListener('click', () => openModal(authModal));
    showDecksBtn.addEventListener('click', () => openModal(decksModal));
    [authModal, decksModal, addWordModal].forEach(m => m.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', () => closeModal(m))));

    // --- 8. INICJALIZACJA APLIKACJI ---
    async function init() {
        db = await openDB();
        const { data: { session } } = await supabaseClient.auth.getSession();
        updateAuthUI(session?.user);
        if (session?.user) {
            await syncAndRenderDecks();
            learningState.classList.remove('hidden');
        } else {
            welcomeState.classList.remove('hidden');
        }
        loadingState.classList.add('hidden');
    }

    init();
});
</script>

<script>
    // Service Worker - na razie pusty, aby nie powodował błędów.
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('Service worker registered.', reg))
                .catch(err => console.log('Service worker registration failed:', err));
        });
    }
</script>

</body>
</html>