(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))v(d);new MutationObserver(d=>{for(const y of d)if(y.type==="childList")for(const C of y.addedNodes)C.tagName==="LINK"&&C.rel==="modulepreload"&&v(C)}).observe(document,{childList:!0,subtree:!0});function r(d){const y={};return d.integrity&&(y.integrity=d.integrity),d.referrerPolicy&&(y.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?y.credentials="include":d.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function v(d){if(d.ep)return;d.ep=!0;const y=r(d);fetch(d.href,y)}})();document.addEventListener("DOMContentLoaded",async()=>{const fe={apiKey:"AIzaSyDI4cJBA8rw2DDav440fk-0erx3ZoG-41o",authDomain:"englishapp-ff793.firebaseapp.com",projectId:"englishapp-ff793",storageBucket:"englishapp-ff793.appspot.com",messagingSenderId:"851511819588",appId:"1:851511819588:web:c91e67102c7338bba62b11",measurementId:"G-9J5Q0E7ZR3"};firebase.initializeApp(fe);const i=firebase.auth(),r=firebase.firestore(),v=firebase.storage();try{await r.enablePersistence({synchronizeTabs:!0})}catch(e){console.warn("Offline persistence not enabled:",e.code||e.message)}const d="en-GB",y=!0,C=1/0,k=()=>{const e=new Date;return e.setHours(0,0,0,0),e},je=(e,t)=>{const n=new Date(e);return n.setDate(n.getDate()+t),n},Z=e=>e.toLocaleDateString("en-GB"),Re=document.getElementById("main-content"),N=document.getElementById("loading-state"),_e=document.getElementById("show-auth-btn"),He=document.getElementById("show-decks-btn"),qe=document.getElementById("show-learned-words-btn"),Pe=document.getElementById("show-stats-btn"),K=document.getElementById("show-stories-btn"),Ve=document.getElementById("show-review-btn"),f=document.getElementById("auth-modal"),z=document.getElementById("decks-modal"),Oe=document.getElementById("learned-words-modal"),Ge=document.getElementById("stats-modal"),he=document.getElementById("stories-modal"),Qe=document.getElementById("story-viewer-modal"),Ee=document.getElementById("add-word-modal"),we=document.getElementById("review-modal"),x=document.getElementById("decks-list"),Ze=document.getElementById("add-deck-form"),Y=document.getElementById("auth-form"),Ke=document.getElementById("login-btn"),Ye=document.getElementById("register-btn"),Je=document.getElementById("logout-btn"),B=document.getElementById("auth-error-message"),be=document.getElementById("auth-success-message"),F=document.getElementById("auth-login-success"),W=document.getElementById("user-info"),ve=document.getElementById("user-email-display"),Xe=document.getElementById("auth-icon-user"),et=document.getElementById("auth-icon-logout"),Be=document.getElementById("verify-email-container"),tt=document.getElementById("verify-email-address"),nt=document.getElementById("resend-verification-button"),j=document.getElementById("active-deck-name"),st=document.getElementById("reset-progress"),D=document.getElementById("learning-state"),R=document.getElementById("summary-state"),_=document.getElementById("test-state"),H=document.getElementById("test-summary-state"),ot=document.getElementById("start-new-session-early"),at=document.getElementById("new-count"),ct=document.getElementById("review-count"),rt=document.getElementById("learned-count"),Le=document.getElementById("flashcard"),dt=document.getElementById("card-rank"),it=document.getElementById("card-english"),lt=document.getElementById("card-polish"),ut=document.getElementById("card-example-en"),mt=document.getElementById("card-example-pl"),J=document.getElementById("card-image"),X=document.getElementById("show-answer-btn"),ee=document.getElementById("difficulty-buttons"),gt=document.getElementById("speak-btn-front"),yt=document.getElementById("speak-btn-back"),Ie=document.getElementById("image-upload-input"),pt=document.getElementById("add-image-btn"),ke=document.getElementById("header-image"),ft=document.getElementById("upload-header-btn"),xe=document.getElementById("header-upload-input"),ht=document.getElementById("upload-global-bg-btn"),Ce=document.getElementById("global-bg-upload-input"),te=document.getElementById("card-front-bg"),Et=document.getElementById("upload-story-bg-btn"),De=document.getElementById("story-bg-upload-input"),Se=document.getElementById("story-viewer-bg-container"),wt=document.getElementById("deck-details-view"),bt=document.getElementById("deck-details-name"),q=document.getElementById("deck-details-words"),Me=document.getElementById("deck-details-source-badge"),vt=document.getElementById("open-add-word-modal-btn"),Bt=document.getElementById("add-word-form"),Lt=document.getElementById("add-word-deck-name"),Ue=document.getElementById("bulk-words-input"),It=document.getElementById("learned-words-list"),kt=document.getElementById("learned-words-count"),xt=document.getElementById("stats-chart");let ne=null;const P=document.getElementById("stories-list"),Ct=document.getElementById("add-story-btn"),Te=document.getElementById("story-upload-input"),Dt=document.getElementById("story-viewer-title"),Ae=document.getElementById("story-viewer-content"),se=document.getElementById("listen-full-story-btn"),St=document.getElementById("speed-slider"),Mt=document.getElementById("test-question"),oe=document.getElementById("test-answers"),ae=document.getElementById("test-next-btn"),Ut=document.getElementById("test-current-question"),Tt=document.getElementById("test-total-questions"),At=document.getElementById("test-score"),$t=document.getElementById("test-summary-total"),Nt=document.getElementById("back-to-main-menu-btn");let ce=null,re=null,m=null,h="None",p=[],b=[],E=[],o=null,V=0,O=!1,S=null,de=[],M=0,U=!1;const G=window.speechSynthesis;let $e=1,T=[],A=0,ie=0,le="en2pl";function g(e){e&&(e.classList.remove("pointer-events-none","opacity-0"),e.querySelector(".modal-content")?.classList.remove("scale-95"))}function w(e){e&&(e.classList.add("pointer-events-none","opacity-0"),e.querySelector(".modal-content")?.classList.add("scale-95"))}document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&w(e)})}),document.querySelectorAll(".modal .close-modal-btn").forEach(e=>{e.addEventListener("click",()=>w(e.closest(".modal")))});function zt(e,t=d,n=1,s){if(!e||!("speechSynthesis"in window)){s?.();return}G.speaking&&G.cancel();const c=speechSynthesis.getVoices().find(u=>u.lang===t&&u.name.toLowerCase().includes("google")),l=new SpeechSynthesisUtterance(e);l.lang=t,l.voice=c||null,l.rate=n,l.onend=()=>s?.(),G.speak(l)}async function Q(e,t=d,n=1,s){zt(e,t,n,s)}_e.addEventListener("click",()=>{const e=i.currentUser;B.classList.add("hidden"),be.classList.add("hidden"),F.classList.add("hidden"),e?(W.classList.remove("hidden"),Y.classList.add("hidden"),ve.textContent=e.email||""):(W.classList.add("hidden"),Y.classList.remove("hidden")),g(f)}),Ye.addEventListener("click",async e=>{e.preventDefault(),B.classList.add("hidden");const t=document.getElementById("auth-email").value.trim(),n=document.getElementById("auth-password").value;try{await(await i.createUserWithEmailAndPassword(t,n)).user.sendEmailVerification(),Y.classList.add("hidden"),be.classList.remove("hidden")}catch(s){B.textContent=s.message||"Register failed",B.classList.remove("hidden")}}),Ke.addEventListener("click",async e=>{e.preventDefault(),B.classList.add("hidden");const t=document.getElementById("auth-email").value.trim(),n=document.getElementById("auth-password").value;try{await i.signInWithEmailAndPassword(t,n),F.textContent="Logged in successfully.",F.classList.remove("hidden"),setTimeout(()=>{F.classList.add("hidden"),w(f)},800)}catch(s){B.textContent=s.message||"Login failed",B.classList.remove("hidden")}}),Je.addEventListener("click",async()=>{await i.signOut(),w(f)}),nt?.addEventListener("click",async()=>{const e=i.currentUser;e&&(await e.sendEmailVerification(),alert("Wysłano ponownie e-mail weryfikacyjny."))});async function Ne(){const e=i.currentUser;if(!e){x.innerHTML='<p class="text-slate-500 text-center p-4">Zaloguj się, aby zobaczyć swoje talie.</p>';return}x.innerHTML='<p class="text-slate-500 text-center p-4">Ładowanie talii...</p>',ce&&ce(),ce=r.collection("decks").where("userId","==",e.uid).orderBy("createdAt","desc").onSnapshot(async t=>{if(t.empty){x.innerHTML='<p class="text-slate-500 text-center p-4">Nie masz jeszcze żadnych talii.</p>';return}x.innerHTML="",t.forEach(n=>{const s={id:n.id,...n.data()},a=document.createElement("div");a.className="p-3 border-b border-slate-100",a.innerHTML=`
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                  <p class="font-bold truncate ${m===s.id?"text-sky-600":""}">${s.name}</p>
                  <p class="text-xs text-slate-500">Deck ID: ${s.id}</p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <button class="select-deck-btn px-3 py-1 bg-sky-500 hover:bg-sky-600 text-white rounded">Ucz się</button>
                  <button class="view-words-btn px-3 py-1 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded">Słówka</button>
                  <button class="rename-btn px-2 py-1 text-slate-500 hover:text-sky-600">✏️</button>
                  <button class="delete-btn px-2 py-1 text-slate-500 hover:text-red-600">🗑️</button>
                </div>
              </div>
            `,a.querySelector(".select-deck-btn").addEventListener("click",async()=>{await Ft(s.id,s.name),w(z)}),a.querySelector(".view-words-btn").addEventListener("click",()=>{Wt(s)}),a.querySelector(".rename-btn").addEventListener("click",async()=>{const c=prompt("Nowa nazwa talii:",s.name);c&&c.trim()&&c.trim()!==s.name&&(await r.collection("decks").doc(s.id).update({name:c.trim()}),s.id===m&&(h=c.trim(),j.textContent=h))}),a.querySelector(".delete-btn").addEventListener("click",async()=>{if(!confirm(`Usunąć talię "${s.name}" i wszystkie jej słowa?`))return;const c=await r.collection("decks").doc(s.id).collection("words").get(),l=400;let u=r.batch(),I=0;c.forEach($=>{u.delete($.ref),I++,I%l===0&&(u.commit(),u=r.batch())}),await u.commit(),await r.collection("decks").doc(s.id).delete(),m===s.id&&(m=null,h="None",j.textContent=h,p=[],L())}),x.appendChild(a)})},t=>{console.error("Decks error:",t),x.innerHTML='<p class="text-red-500 text-center p-4">Błąd ładowania talii.</p>'})}Ze.addEventListener("submit",async e=>{e.preventDefault();const t=i.currentUser;if(!t)return alert("Musisz być zalogowany.");const n=document.getElementById("new-deck-name"),s=n.value.trim();s&&(await r.collection("decks").add({name:s,userId:t.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),n.value="")});async function Ft(e,t){m=e,h=t||"Deck",j.textContent=h,await jt()}async function Wt(e){wt.classList.remove("hidden"),bt.textContent=e.name,Me.textContent="Cloud",Me.className="text-xs px-2 py-1 rounded-full bg-violet-100 text-violet-700",q.innerHTML='<p class="text-slate-500 text-sm">Ładowanie...</p>';const t=await r.collection("decks").doc(e.id).collection("words").orderBy("createdAt","asc").get();if(t.empty){q.innerHTML='<p class="text-slate-500 text-sm">Brak słów w tej talii.</p>';return}q.innerHTML="",t.forEach(n=>{const s=n.data(),a=document.createElement("div");a.className="text-sm py-1",a.textContent=`${s.english} - ${s.polish}`,q.appendChild(a)}),g(z)}vt.addEventListener("click",()=>{if(!m){alert("Najpierw wybierz talię.");return}Lt.textContent=h||"Deck",Ue.value="",w(z),g(Ee)}),Bt.addEventListener("submit",async e=>{if(e.preventDefault(),!i.currentUser)return alert("Musisz być zalogowany.");if(!m)return alert("Brak aktywnej talii.");const n=(Ue.value||"").trim();if(!n)return;const s=n.split(`
`).map(I=>I.trim()).filter(Boolean),a=400;let c=r.batch(),l=0;const u=r.collection("decks").doc(m).collection("words");for(const I of s){const $=I.split(";").map(Jt=>Jt.trim());if($.length!==2&&$.length!==4){alert(`Nieprawidłowy format: "${I}". Użyj "ang;pl" albo "ang;pl;przykład_en;przykład_pl".`);return}const[Gt,Qt,Zt="",Kt=""]=$,Yt=u.doc();c.set(Yt,{english:Gt,polish:Qt,example_en:Zt,example_pl:Kt,imageUrl:null,interval:0,easeFactor:2.5,nextReview:firebase.firestore.Timestamp.fromDate(k()),successCount:0,learnedDate:null,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),l++,l%a===0&&(await c.commit(),c=r.batch())}await c.commit(),w(Ee),alert(`${l} słów dodano do "${h}".`)});async function jt(){if(!m){p=[],L();return}re&&re();let e=!0;re=r.collection("decks").doc(m).collection("words").orderBy("createdAt","asc").onSnapshot(t=>{p=t.docs.map(n=>({id:n.id,...n.data()})),e&&(L(),e=!1)},t=>console.error("Words snapshot error:",t))}function Rt(){const e=p.filter(t=>(t.successCount||0)>=3).length;rt.textContent=e}function _t(e=null){if(e){b=[],E=[...e].sort(()=>Math.random()-.5);return}k();const t=p.filter(s=>(s.interval||0)===0),n=p.filter(s=>(s.interval||0)>0&&y);b=t.slice(0,C),E=n.sort(()=>Math.random()-.5)}function L(e=null){if(V=0,O=!1,D.classList.remove("hidden"),_.classList.add("hidden"),H.classList.add("hidden"),R.classList.add("hidden"),!m){N.innerHTML='<p class="text-center text-slate-500 p-8">Select or create a deck to start learning.</p>',N.style.display="block",D.classList.add("hidden");return}N.style.display="none",_t(e),E.length===0&&b.length===0?me():(ue(),Fe())}function ue(){Le.classList.remove("is-flipped"),ee.classList.add("hidden"),X.classList.remove("hidden"),setTimeout(()=>{E.length>0?(o=E.shift(),o.type="review"):b.length>0?(o=b.shift(),o.type="new",o.isLearning=!0):o=null,o?(ze(),Fe()):me()},300)}function ze(){S&&(te.src=S),dt.textContent=`#${o.id}`,it.textContent=o.english||"",lt.textContent=o.polish||"",ut.textContent=o.example_en||"",mt.textContent=o.example_pl||"",o.imageUrl?(J.src=o.imageUrl,J.style.display="block"):J.style.display="none"}function Fe(){const e=o&&o.type==="new"?1:0,t=o&&o.type==="review"?1:0;at.textContent=b.length+e,ct.textContent=E.length+t,Rt()}function me(){D.classList.add("hidden"),_.classList.add("hidden"),H.classList.add("hidden"),R.classList.remove("hidden");const e=b.length>0||E.length>0,t=document.querySelector("#summary-state p"),n=document.getElementById("start-new-session-early");e?(t.textContent="Masz świetną passę. Tak trzymaj!",n.textContent="Keep going!",n.disabled=!1,O=!1):(t.textContent="Gratulacje! Ukończyłeś całą talię :)",n.textContent="Start again.",n.disabled=!1,O=!0)}async function Ht(e){if(!o)return;const t=r.collection("decks").doc(m).collection("words").doc(o.id);e===1?(o.interval=0,E.unshift(o)):e===3&&(o.isLearning=!1,o.interval=Math.max(1,(o.interval||0)*(o.easeFactor||2.5)),o.easeFactor=(o.easeFactor||2.5)+.1,o.successCount=(o.successCount||0)+1,o.successCount===3&&!o.learnedDate&&(o.learnedDate=firebase.firestore.Timestamp.fromDate(k()))),o.nextReview=firebase.firestore.Timestamp.fromDate(je(k(),Math.round(o.interval||0))),await t.update({interval:o.interval||0,easeFactor:o.easeFactor||2.5,nextReview:o.nextReview||null,successCount:o.successCount||0,learnedDate:o.learnedDate||null}),V++,V>0&&V%100===0&&(b.length>0||E.length>0)?me():ue()}X.addEventListener("click",()=>{Le.classList.add("is-flipped"),X.classList.add("hidden"),ee.classList.remove("hidden"),o&&setTimeout(()=>Q(o.example_en,d,1),400)}),ee.addEventListener("click",e=>{const t=e.target.closest("button");t&&t.dataset.difficulty&&Ht(parseInt(t.dataset.difficulty,10))}),gt.addEventListener("click",e=>{e.stopPropagation(),o&&Q(o.english,d,1)}),yt.addEventListener("click",e=>{e.stopPropagation(),o&&Q(o.example_en,d,1)}),ot.addEventListener("click",()=>{O?(R.classList.add("hidden"),L([...p])):(R.classList.add("hidden"),D.classList.remove("hidden"),ue())}),Ve.addEventListener("click",()=>g(we)),document.querySelectorAll(".review-btn-learn, .review-btn-test").forEach(e=>{e.addEventListener("click",()=>{if(p.length===0){alert("Brak słów w aktywnej talii.");return}const t=e.dataset.type,n=e.dataset.count?parseInt(e.dataset.count,10):null,s=p.filter(l=>(l.successCount||0)>=3);let a=[];if(t==="last"&&n)a=s.filter(l=>l.learnedDate).sort((l,u)=>l.learnedDate.toMillis()-u.learnedDate.toMillis()).slice(-n).reverse();else if(t==="today"){const l=Z(k());a=s.filter(u=>u.learnedDate&&Z(u.learnedDate.toDate())===l)}else a=s;const c=e.classList.contains("review-btn-test");w(we),c?(le=e.dataset.direction||"en2pl",qt(a)):L(a)})});function qt(e){if(!e||e.length<4){alert("Za mało słów do testu.");return}D.classList.add("hidden"),_.classList.remove("hidden"),H.classList.add("hidden"),T=e.sort(()=>Math.random()-.5),ie=0,A=0,We()}function We(){if(A>=T.length){Vt();return}const e=T[A];Ut.textContent=A+1,Tt.textContent=T.length,ae.classList.add("hidden"),Mt.textContent=le==="pl2en"?e.polish:e.english;const t=p.filter(c=>c.id!==e.id);let n=[e];for(;n.length<4&&t.length>0;){const c=Math.floor(Math.random()*t.length);n.push(t.splice(c,1)[0])}n.sort(()=>Math.random()-.5),oe.innerHTML="";const s=e.id,a=n.map(c=>c.id===s);n.forEach((c,l)=>{const u=document.createElement("button");u.className="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors",u.textContent=le==="pl2en"?c.english:c.polish,u.onclick=()=>Pt(c.id===s,u,a),oe.appendChild(u)})}function Pt(e,t,n){Array.from(oe.querySelectorAll("button")).forEach((a,c)=>{a.disabled=!0,n[c]&&a.classList.add("!bg-green-200","border-green-400")}),e?(ie++,t.classList.add("!bg-green-500","text-white")):t.classList.add("!bg-red-500","text-white"),ae.classList.remove("hidden")}ae.addEventListener("click",()=>{A++,We()});function Vt(){_.classList.add("hidden"),H.classList.remove("hidden"),At.textContent=ie,$t.textContent=T.length}Nt.addEventListener("click",()=>L()),qe.addEventListener("click",()=>{const e=p.filter(t=>(t.successCount||0)>=3).sort((t,n)=>{const s=t.learnedDate?.toMillis?.()||0,a=n.learnedDate?.toMillis?.()||0;return s-a});It.innerHTML=e.length?e.map(t=>`<div class="py-2 border-b"><span class="font-bold w-24 inline-block">${t.english}</span><span>${t.polish}</span></div>`).join(""):'<p class="text-slate-500 text-center p-4">You haven’t learned any words yet. Keep going!</p>',kt.textContent=e.length,g(Oe)}),Pe.addEventListener("click",()=>{const e=p.filter(n=>(n.successCount||0)>=3&&n.learnedDate).reduce((n,s)=>{const a=Z(s.learnedDate.toDate());return n[a]=(n[a]||0)+1,n},{}),t=Object.keys(e).sort((n,s)=>new Date(n)-new Date(s));ne&&ne.destroy(),ne=new Chart(xt,{type:"bar",data:{labels:t,datasets:[{label:"Words learned",data:t.map(n=>e[n]),backgroundColor:"rgba(59, 130, 246, 0.5)",borderColor:"rgba(59, 130, 246, 1)",borderWidth:1}]},options:{scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{display:!1}}}}),g(Ge)}),K.addEventListener("click",async()=>{const e=i.currentUser;if(!e){g(f);return}P.innerHTML='<p class="text-center text-slate-500 p-4">Ładowanie...</p>';const t=await r.collection("users").doc(e.uid).collection("stories").orderBy("title","asc").get();P.innerHTML="",t.empty?P.innerHTML='<p class="text-center text-slate-500 p-8">Your library is empty. Add your first story from a .txt file.</p>':t.forEach(n=>Ot({id:n.id,...n.data()})),g(he)});function Ot(e){const t=document.createElement("div");t.className="flex justify-between items-center p-3 hover:bg-slate-100 rounded-lg cursor-pointer",t.innerHTML=`
        <p class="truncate pr-4">${e.title}</p>
        <button data-id="${e.id}" class="delete-story-btn text-slate-400 hover:text-red-500 transition-colors flex-shrink-0">&times;</button>
      `,t.addEventListener("click",n=>{n.target.closest(".delete-story-btn")||(Dt.textContent=e.title,Ae.textContent=e.content||"",w(he),g(Qe))}),t.querySelector(".delete-story-btn").addEventListener("click",async n=>{if(n.stopPropagation(),!confirm(`Delete "${e.title}"?`))return;const s=i.currentUser;s&&(await r.collection("users").doc(s.uid).collection("stories").doc(e.id).delete(),K.click())}),P.appendChild(t)}Ct.addEventListener("click",()=>Te.click()),Te.addEventListener("change",e=>{const t=i.currentUser;if(!t){g(f);return}const n=e.target.files[0];if(n&&n.name.endsWith(".txt")){const s=new FileReader;s.onload=async a=>{await r.collection("users").doc(t.uid).collection("stories").add({title:n.name,content:a.target.result||"",createdAt:firebase.firestore.FieldValue.serverTimestamp()}),K.click()},s.readAsText(n)}e.target.value=""});let ge=se.querySelector(".play-icon"),ye=se.querySelector(".stop-icon");St.addEventListener("input",e=>{$e=parseFloat(e.target.value||"1")}),se.addEventListener("click",()=>{if(U)U=!1,G.cancel(),ge.classList.remove("hidden"),ye.classList.add("hidden");else{const e=Ae.textContent||"";e&&(U=!0,de=e.match(/[^.!?]+[.!?]+/g)||[e],M=0,ge.classList.add("hidden"),ye.classList.remove("hidden"),pe())}});function pe(){if(!U||M>=de.length){U=!1,ge.classList.remove("hidden"),ye.classList.add("hidden");return}const e=(de[M]||"").trim();e?Q(e,d,$e,()=>{M++,pe()}):(M++,pe())}pt.addEventListener("click",()=>{o&&Ie.click()}),Ie.addEventListener("change",async e=>{const t=i.currentUser;if(!t){g(f);return}const n=e.target.files[0];if(!n||!o||!m)return;const s=`users/${t.uid}/images/${Date.now()}_${n.name}`,a=v.ref().child(s);await a.put(n);const c=await a.getDownloadURL();await r.collection("decks").doc(m).collection("words").doc(o.id).update({imageUrl:c}),o.imageUrl=c,ze(),e.target.value=""}),ft.addEventListener("click",()=>xe.click()),xe.addEventListener("change",async e=>{const t=i.currentUser;if(!t){g(f);return}const n=e.target.files[0];if(!n)return;const s=`users/${t.uid}/backgrounds/header_${Date.now()}_${n.name}`,a=v.ref().child(s);await a.put(n);const c=await a.getDownloadURL();ke.src=c,await r.collection("users").doc(t.uid).collection("settings").doc("ui").set({headerImageUrl:c},{merge:!0}),e.target.value=""}),ht.addEventListener("click",()=>Ce.click()),Ce.addEventListener("change",async e=>{const t=i.currentUser;if(!t){g(f);return}const n=e.target.files[0];if(!n)return;const s=`users/${t.uid}/backgrounds/flashcard_${Date.now()}_${n.name}`,a=v.ref().child(s);await a.put(n);const c=await a.getDownloadURL();S=c,te.src=c,await r.collection("users").doc(t.uid).collection("settings").doc("ui").set({globalFlashcardBgUrl:c},{merge:!0}),e.target.value=""}),Et.addEventListener("click",()=>De.click()),De.addEventListener("change",async e=>{const t=i.currentUser;if(!t){g(f);return}const n=e.target.files[0];if(!n)return;const s=`users/${t.uid}/backgrounds/story_${Date.now()}_${n.name}`,a=v.ref().child(s);await a.put(n);const c=await a.getDownloadURL();Se.style.backgroundImage=`url(${c})`,await r.collection("users").doc(t.uid).collection("settings").doc("ui").set({storyBgUrl:c},{merge:!0}),e.target.value=""}),st.addEventListener("click",async()=>{if(!m)return alert("Brak aktywnej talii.");if(!confirm("Zresetować postęp (SRS) dla tej talii?"))return;const e=await r.collection("decks").doc(m).collection("words").get(),t=400;let n=r.batch(),s=0;e.forEach(a=>{n.update(a.ref,{interval:0,easeFactor:2.5,nextReview:firebase.firestore.Timestamp.fromDate(k()),successCount:0,learnedDate:null}),s++,s%t===0&&(n.commit(),n=r.batch())}),await n.commit(),alert("Postęp zresetowany.")}),He.addEventListener("click",()=>{if(!i.currentUser){g(f);return}Ne(),g(z)}),i.onAuthStateChanged(async e=>{const t=!!e;if(Xe.classList.toggle("hidden",t),et.classList.toggle("hidden",!t),N.style.display="none",Re.style.display="block",e&&!e.emailVerified?(tt.textContent=e.email||"",Be.style.display="block"):Be.style.display="none",t){W.classList.remove("hidden"),ve.textContent=e.email||"";const s=(await r.collection("users").doc(e.uid).collection("settings").doc("ui").get()).data()||{};s.headerImageUrl&&(ke.src=s.headerImageUrl),s.globalFlashcardBgUrl&&(S=s.globalFlashcardBgUrl,te.src=S),s.storyBgUrl&&(Se.style.backgroundImage=`url(${s.storyBgUrl})`),Ne()}else W.classList.add("hidden"),m=null,h="None",j.textContent=h,p=[],L()})});
