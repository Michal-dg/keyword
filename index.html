<!DOCTYPE html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Keyword: Master English</title> 
  <script src="https://cdn.tailwindcss.com"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> 
  <link rel="manifest" href="manifest.json"> 
  <meta name="theme-color" content="#0284c7"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  <meta name="apple-mobile-web-app-title" content="Keyword"> 
  <link rel="apple-touch-icon" href="icons/icon-192x192.png"> 
  <link rel="icon" href="/icons/icon-192x192.png" type="image/png"> 
  <script src="words_db_en.js"></script> 
  <script src="stories_db_en.js"></script> 
  <style> 
    body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; } 
    .card { transform-style: preserve-3d; transition: transform 0.6s; } 
    .card.is-flipped { transform: rotateY(180deg); } 
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; transform: translateZ(0); } 
    .card-face-back { transform: rotateY(180deg) translateZ(1px); } 
    .btn-difficulty { transition: all 0.2s ease-in-out; } 
    .btn-difficulty:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); } 
    .modal { transition: opacity 0.3s ease; } 
    .modal-content { transition: transform 0.3s ease; } 
    #header-image-container:hover #upload-header-btn, .card-face-front:hover #upload-global-bg-btn { opacity: 1; } 
  </style> 
</head> 
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen"> 
  <input type="file" id="image-upload-input" class="hidden" accept="image/*"> 
  <input type="file" id="header-upload-input" class="hidden" accept="image/*"> 
  <input type="file" id="story-upload-input" class="hidden" accept=".txt"> 
  <input type="file" id="global-bg-upload-input" class="hidden" accept="image/*"> 
  <input type="file" id="story-bg-upload-input" class="hidden" accept="image/*"> 

  <div id="app" class="w-full max-w-md mx-auto p-4 sm:p-6"> 
    <header class="text-center mb-4"> 
      <div id="header-image-container" class="relative w-full aspect-[3.5/1] bg-slate-200 rounded-lg mb-4 overflow-hidden group"> 
        <img id="header-image" src="images/default-header.jpg" alt="Header" class="w-full h-full object-cover"> 
        <button id="upload-header-btn" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white opacity-0 group-hover:opacity-100 transition-opacity"> 
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> 
          <span class="ml-2">Change Photo</span> 
        </button> 
      </div> 
      <h1 class="text-3xl sm:text-4xl font-bold text-sky-600">Keyword</h1> 
      <p class="text-slate-500 mt-1">Master English, word by word!</p> 
    </header> 

    <nav class="relative flex justify-center items-center space-x-2 sm:space-x-4 mb-6 border-b pb-4"> 
      <button id="show-auth-btn" title="User Account" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg id="auth-icon-user" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> 
        <svg id="auth-icon-logout" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> 
      </button> 
      <button id="show-decks-btn" title="Decks" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 16V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"></path><path d="M20 12v4H4v-4"></path><path d="M4 8h16"></path></svg> 
      </button> 
      <button id="show-learned-words-btn" title="Learned Words" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11 3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg> 
      </button> 
      <button id="show-stats-btn" title="Progress Chart" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> 
      </button> 
      <button id="show-stories-btn" title="Story Library" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1-3-3h7z"></path></svg> 
      </button> 
      <button id="show-review-btn" title="Review Session" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-sky-100 hover:text-sky-600 transition-colors"> 
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg> 
      </button> 
    </nav>

    <script>
document.addEventListener('DOMContentLoaded', async () => {
  // --- SUPABASE & APP CONFIGURATION ---
  const SUPABASE_URL = 'https://elneujplpdoruvrvzvzd.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsbmV1anBscGRvcnV2cnZ6dnpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDQ3NjYsImV4cCI6MjA3MjM4MDc2Nn0.YIJYmt8KeiXH0iFS_Pk6ErIkyKZpPDsi29G83VItjCc';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase client initialized successfully.');

  const ENGLISH_ACCENT = 'en-GB';
  const REVIEW_IGNORE_DATE = true;
  const DAILY_NEW_LIMIT = Infinity;

  if (typeof initialWordList === 'undefined') {
    document.getElementById('loading-state').innerHTML = '<p class="text-red-500 font-bold">Error: Could not load word database. Make sure `words_db_en.js` is in the same folder.</p>';
    return;
  }

  // --- AUTH REDIRECT HANDLER ---
  async function handleAuthRedirectFromEmail() {
    const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
    if (!hash) return;
    const params = new URLSearchParams(hash);
    const access_token = params.get('access_token');
    const refresh_token = params.get('refresh_token');
    const type = params.get('type');
    if (access_token && refresh_token) {
      const { error } = await supabaseClient.auth.setSession({ access_token, refresh_token });
      if (error) {
        console.error('Error setting session from URL hash:', error);
      } else {
        console.log('Session restored from email link.');
        try { closeModal(authModal); } catch (_) {}
      }
    }
    if (type === 'recovery') {
      const newPass = prompt('Enter new password:');
      if (newPass) {
        const { error: updateErr } = await supabaseClient.auth.updateUser({ password: newPass });
        if (updateErr) alert('Could not update password: ' + updateErr.message);
        else alert('Password updated. You are now logged in.');
      }
    }
    history.replaceState({}, document.title, window.location.pathname);
  }

  // --- CLEAR LOCAL USER DATA ---
  async function clearLocalUserData() {
    console.log('Clearing local user data from IndexedDB...');
    await waitForDB();
    const storesToClear = ['decks', 'words', 'user_stories'];
    const transaction = db.transaction(storesToClear, 'readwrite');
    for (const storeName of storesToClear) {
      const store = transaction.objectStore(storeName);
      await idbRequest(store.clear());
    }
    await new Promise(resolve => transaction.oncomplete = resolve);
    await setAppData('activeDeckId', null);
    activeDeckId = null;
    activeDeckNameEl.textContent = 'None';
    words = [];
    startSession();
    console.log('Local user data cleared.');
  }

  // --- REINITIALIZE ON VISIBILITY CHANGE ---
  async function reinitializeAppState() {
    console.log('App is visible again. Re-initializing state...');
    try {
      db = await openDB();
      console.log('IndexedDB connection re-established.');
      if (activeDeckId) {
        await loadWordsForActiveDeck();
      }
      startSession();

      const { data: { session } } = await supabaseClient.auth.getSession();
      const isLoggedIn = !!(session && session.user);
      authIconUser.classList.toggle('hidden', isLoggedIn);
      authIconLogout.classList.toggle('hidden', !isLoggedIn);
      console.log('State re-initialization 

      